<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Me-API Playground</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container my-5">
    <h1 class="text-primary mb-4">Me-API Playground</h1>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Server Health</h5>
        <p id="health" class="card-text text-secondary">Checking...</p>
      </div>
    </div>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Your Profile</h5>
        <div id="profile">Loading...</div>
        <button class="btn btn-primary mt-3" onclick="refreshProfile()">Refresh</button>
      </div>
    </div>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Search</h5>
        <div class="input-group mb-3">
          <input id="q" type="text" class="form-control" placeholder="Search by skill, project, or keyword">
          <button class="btn btn-outline-primary" onclick="doSearch()">Search</button>
        </div>
        <div id="searchResults"></div>
      </div>
    </div>

    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Projects</h5>
        <div class="input-group mb-3">
          <input id="skill" type="text" class="form-control" placeholder="Filter by skill e.g. Python">
          <button class="btn btn-outline-success" onclick="filterBySkill()">Filter</button>
          <button class="btn btn-secondary" onclick="loadProjects()">All</button>
        </div>
        <div id="projects"></div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const API = "https://me-api-playground-9w03.onrender.com";

  async function checkHealth(){
    try {
      const r = await fetch(API + "/health");
      const j = await r.json();
      document.getElementById("health").innerText = `Status: ${r.status} (${j.status})`;
    } catch (err) {
      document.getElementById("health").innerText = "‚ùå Cannot reach backend API";
    }
  }

  async function refreshProfile(){
    try {
      const r = await fetch(API + "/profile");
      if(r.status === 204){
        document.getElementById("profile").innerHTML = "<em>No profile found in DB.</em>";
        return;
      }
      const j = await r.json();
      document.getElementById("profile").innerHTML = `
        <strong>${j.name}</strong> (${j.email})<br>
        <small>${j.education}</small><br>
        <b>Skills:</b> ${(j.skills || []).join(", ")}<br>
        <b>Links:</b> ${Object.entries(j.links || {})
          .map(([k,v]) => `<a href="${v}" target="_blank">${k}</a>`)
          .join(" | ")}
      `;
    } catch (err) {
      document.getElementById("profile").innerHTML = "‚ö†Ô∏è Failed to load profile.";
      console.error(err);
    }
  }

  async function loadProjects(skill){
    try {
      const url = skill
        ? `${API}/projects?skill=${encodeURIComponent(skill)}`
        : `${API}/projects`;
      const r = await fetch(url);
      const arr = await r.json();
      if(!arr.length){
        document.getElementById("projects").innerHTML = "<em>No projects found.</em>";
        return;
      }
      document.getElementById("projects").innerHTML = arr.map(p => `
        <div class="border-bottom pb-2 mb-2">
          <h6>${p.title}</h6>
          <small>${p.description}</small><br>
          <b>Skills:</b> ${(p.skills || []).join(", ")}<br>
          <a href="${(p.links || [])[0]}" target="_blank">üîó View Project</a>
        </div>
      `).join("");
    } catch (err) {
      document.getElementById("projects").innerHTML = "‚ö†Ô∏è Error loading projects.";
      console.error(err);
    }
  }

  async function doSearch(){
    const q = document.getElementById("q").value.trim();
    if(!q) return alert("Enter a query");
    try {
      const r = await fetch(`${API}/search?q=${encodeURIComponent(q)}`);
      const j = await r.json();
      let html = "";
      if(j.profile) html += `<p><strong>Profile match:</strong> ${j.profile.name}</p>`;
      if(j.projects?.length){
        html += "<h6>Matching Projects</h6>";
        j.projects.forEach(p=>{
          html += `<div><b>${p.title}</b> - ${p.description}</div>`;
        });
      }
      if(j.skills?.length) html += `<p><b>Skills:</b> ${j.skills.join(", ")}</p>`;
      document.getElementById("searchResults").innerHTML = html || "<em>No results.</em>";
    } catch (err) {
      document.getElementById("searchResults").innerHTML = "‚ö†Ô∏è Search failed.";
      console.error(err);
    }
  }

  // Event listeners
  document.getElementById("skill").addEventListener("keyup", e => {
    if(e.key === "Enter") loadProjects(e.target.value.trim());
  });

  // Run when page loads
  checkHealth();
  refreshProfile();
  loadProjects();

  // Expose for buttons
  window.doSearch = doSearch;
  window.loadProjects = loadProjects;
  window.refreshProfile = refreshProfile;
});
</script>

</body>
</html>
